kind: pipeline
name: default

steps:
- name: restore-cache
  image: plugins/volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    restore: true
    mount:
      - ./vendor/bundle

- name: bundle-install
  image: ruby:2.6.1
  depends_on:
    - restore-cache
  commands:
    - bundle install --path vendor/bundle --clean

- name: rubocop
  image: ruby:2.6.1
  depends_on:
    - bundle-install
  commands:
    - bundle exec rubocop -R -fs app spec
    - bundle exec rspec

- name: rspec
  image: ruby:2.6.1
  depends_on:
    - bundle-install
  environment:
    DATABASE_HOST: 'db'
    DATABASE_PORT: 3306
  commands:
    - bundle exec rspec

- name: rebuild-cache
  image: plugins/volume-cache
  volumes:
  - name: cache
    path: /cache
  depends_on:
    - rubocop
    - rspec
  settings:
    rebuild: true
    mount:
      - ./vendor/bundle

- name: notify-slack
  image: plugins/slack
  settings:
    webhook:
      from_secret: webhook

volumes:
- name: cache
  host:
    path: /tmp/cache/drone-rails-example

services:
- name: db
  image: mysql:5.7
  environment:
    MYSQL_DATABASE: 'drone_example_test'
    MYSQL_USER: 'drone_example_test'
    MYSQL_PASSWORD: 'drone_example'
    MYSQL_RANDOM_ROOT_PASSWORD: true
    TZ: 'Asia/Tokyo'
